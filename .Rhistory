otherPara = getOtherPara(cond, stepDuration)
tempt = QStarModel(para, MSPara, otherPara, cond)
condIdx = 2
cond = conditions[condIdx];
condName = conditionNames[condIdx]
condColor = conditionColors[condIdx]
sprintf('Condition : %s %s', cond, condName)
trialTick = trialTicks[[condName]]
########### choose the para and simulate data #############
combIdx = 100
para = initialSpace[combIdx,]
MSPara = getMSPara(cond, stepDuration, nMS, traceValues, sigma)
otherPara = getOtherPara(cond, stepDuration)
tempt = QStarModel(para, MSPara, otherPara, cond)
condIdx = 2
cond = conditions[condIdx];
condName = conditionNames[condIdx]
condColor = conditionColors[condIdx]
sprintf('Condition : %s %s', cond, condName)
trialTick = trialTicks[[condName]]
combIdx = 100
para = initialSpace[combIdx,]
MSPara = getMSPara(cond, stepDuration, nMS, traceValues, sigma)
stepDuration = 0.5
combIdx = 100
para = initialSpace[combIdx,]
MSPara = getMSPara(cond, stepDuration, nMS, traceValues, sigma)
otherPara = getOtherPara(cond, stepDuration)
tempt = QStarModel(para, MSPara, otherPara, cond)
otherPara = getOtherPara(cond, stepDuration)
MSPara = getMSPara(cond, stepDuration, nMS, traceValues, sigma)
load('outputs/QStarData/hdrData.RData')
if(condName == 'LP') hdrData = hdrLPData else hdrData = hdrHPData
condIdx = 2
cond = conditions[condIdx];
condName = conditionNames[condIdx]
condColor = conditionColors[condIdx]
sprintf('Condition : %s %s', cond, condName)
# choose hdrData depending on Cond
load('outputs/QStarData/hdrData.RData')
if(condName == 'LP') hdrData = hdrLPData else hdrData = hdrHPData
stepDuration = hdrData$stepDuration
traceValues = hdrData$traceValues
sigma = hdrData$sigma
combIdx = 100
para = initialSpace[combIdx,]
MSPara = getMSPara(cond, stepDuration, nMS, traceValues, sigma)
otherPara = getOtherPara(cond, stepDuration)
tempt = QStarModel(para, MSPara, otherPara, cond)
para = initialSpace[combIdx,]
MSPara = getMSPara(cond, stepDuration, nMS, traceValues, sigma)
otherPara = getOtherPara(cond, stepDuration)
getOtherPara(cond, stepDuration)
otherPara = getOtherPara(cond, stepDuration)
load('outputs/QStarData/initialSpace.RData')
source('subFxs/helperFxs.R')
source('subFxs/paraFxs.R')
source('subFxs/wtwSettings.R')
otherPara = getOtherPara(cond, stepDuration)
tempt = QStarModel(para, MSPara, otherPara, cond)
blockData = data.frame(trialEarnings = tempt$trialEarnings,
scheduledWait = tempt$rewardDelays,
timeWaited = tempt$timeWaited,
trialNum = 1 : length(tempt$timeWaited)
)
endTick = match(0, tempt$rewardDelays) - 1
blockData = blockData[1:endTick, ]
trialPlots(blockData, label)
totalEarnings = sum(tempt$trialEarnings)
waitDuration = tempt$timeWaited
rewardDelay = tempt$rewardDelays
quitIdx = (tempt$trialEarnings == 0)
waitDuration[is.na(waitDuration)] = rewardDelay[is.na(waitDuration)]
endTick = match(0,rewardDelay)
waitDuration = waitDuration[1 : (endTick - 1)]
quitIdx = quitIdx[1 : (endTick - 1)]
kmscResults =  kmscSimple(waitDuration, quitIdx, tMax, trialTick)
AUC = kmscResults$auc
label = sprintf('earn: %d, AUC: %.2f',
totalEarnings, AUC)
totalEarnings = sum(tempt$trialEarnings)
waitDuration = tempt$timeWaited
rewardDelay = tempt$rewardDelays
quitIdx = (tempt$trialEarnings == 0)
waitDuration[is.na(waitDuration)] = rewardDelay[is.na(waitDuration)]
endTick = match(0,rewardDelay)
waitDuration = waitDuration[1 : (endTick - 1)]
quitIdx = quitIdx[1 : (endTick - 1)]
kmscResults =  kmscSimple(waitDuration, quitIdx, tMax, trialTick)
tMax = hdrData$tMax
kmscResults =  kmscSimple(waitDuration, quitIdx, tMax, trialTick)
AUC = kmscResults$auc
label = sprintf('earn: %d, AUC: %.2f',
totalEarnings, AUC)
######### plot survival curve ##########
plotData = data.frame(pSurvival = kmscResults$kmOnGrid, time = trialTicks[[condName]])
ggplot(plotData, aes(time, pSurvival)) + geom_line() + ylim(c(0, 1)) + displayTheme +
ggtitle(label)
source('subFxs/plotThemes.R')
######### plot survival curve ##########
plotData = data.frame(pSurvival = kmscResults$kmOnGrid, time = trialTicks[[condName]])
ggplot(plotData, aes(time, pSurvival)) + geom_line() + ylim(c(0, 1)) + displayTheme +
ggtitle(label)
############ plot the dynamics for action values #######
vaWaits = tempt$vaWaits
vaQuits = tempt$vaQuits
wIni = para[5]
gamma = para[3]
nTimeStep = otherPara$tMax / otherPara$stepDuration
for(i in 1 : endTick){
vaQuits[is.na(vaQuits[,i]),i] = vaQuits[match(NA, vaQuits[,i]) -1,i]
}
for(i in 1: endTick){
cIdx = i
plotData = data.frame(va =c(vaWaits[,cIdx], vaQuits[,cIdx]),
time = rep( 1 : (otherPara$tMax / otherPara$stepDuration), 2),
action = rep(c('wait', 'quit'),
each = otherPara$tMax / otherPara$stepDuration))
label = sprintf('last, rwd = %d, tw = %.2f; rwd = %d, tw =%.2f',
tempt$trialEarnings[i-1], waitDuration[i-1],
tempt$trialEarnings[i], waitDuration[i])
if(is.na(tempt$timeWaited[i] )){
int_num = floor(tempt$rewardDelays[i])
endStep =  tempt$rewardDelays[i] + 0.5  + 0.5 * ((tempt$rewardDelays[i] - int_num) > 0.5)
endStep = endStep / stepDuration
}else{
endStep = tempt$timeWaited[i] / stepDuration
}
p = ggplot(plotData, aes(time, va, color = action)) + geom_line() +
geom_vline(xintercept = endStep) +
ggtitle(label) + xlab('step')
print(p)
readline(prompt = paste(i, '(hit ENTER to continue)'))
}
i = 1
label = sprintf('last, rwd = %d, tw = %.2f; rwd = %d, tw =%.2f',
tempt$trialEarnings[i-1], waitDuration[i-1],
tempt$trialEarnings[i], waitDuration[i])
sprintf('Trial %d, ', i)
c(trialTitle, rewardTitle)
trialTitle =  sprintf('Trial %d, ', i)
rewardTitle = sprintf('preR = %d, preT = %.2f; nowR = %d, nowT =%.2f',
tempt$trialEarnings[i-1], waitDuration[i-1],
tempt$trialEarnings[i], waitDuration[i])
label = c(trialTitle, rewardTitle)
# plot for each time step
for(i in 1: endTick){
cIdx = i
plotData = data.frame(va =c(vaWaits[,cIdx], vaQuits[,cIdx]),
time = rep( 1 : (otherPara$tMax / otherPara$stepDuration), 2),
action = rep(c('wait', 'quit'),
each = otherPara$tMax / otherPara$stepDuration))
trialTitle =  sprintf('Trial %d, ', i)
rewardTitle = sprintf('preR = %d, preT = %.2f; nowR = %d, nowT =%.2f',
tempt$trialEarnings[i-1], waitDuration[i-1],
tempt$trialEarnings[i], waitDuration[i])
label = c(trialTitle, rewardTitle)
if(is.na(tempt$timeWaited[i] )){
int_num = floor(tempt$rewardDelays[i])
endStep =  tempt$rewardDelays[i] + 0.5  + 0.5 * ((tempt$rewardDelays[i] - int_num) > 0.5)
endStep = endStep / stepDuration
}else{
endStep = tempt$timeWaited[i] / stepDuration
}
p = ggplot(plotData, aes(time, va, color = action)) + geom_line() +
geom_vline(xintercept = endStep) +
ggtitle(label) + xlab('time step') + ylab('action value') + displayTheme
print(p)
readline(prompt = paste(i, '(hit ENTER to continue)'))
}
# load functions and data
load('outputs/QStarData/initialSpace.RData')
source('subFxs/helperFxs.R')
source('subFxs/paraFxs.R')
source('subFxs/wtwSettings.R')
source('subFxs/plotThemes.R')
source('model.R')
library('ggplot2')
library('dplyr')
library('tidyr')
tempt = QStarModel(para, MSPara, otherPara, cond)
View(tempt)
vaWaits = tempt$vaWaits
vaQuits = tempt$vaQuits
cIdx = i
plotData = data.frame(va =c(vaWaits[,cIdx], vaQuits[,cIdx]),
time = rep( 1 : (otherPara$tMax / otherPara$stepDuration), 2),
action = rep(c('wait', 'quit'),
each = otherPara$tMax / otherPara$stepDuration))
trialTitle =  sprintf('Trial %d, ', i)
rewardTitle = sprintf('preR = %d, preT = %.2f; nowR = %d, nowT =%.2f',
tempt$trialEarnings[i-1], waitDuration[i-1],
tempt$trialEarnings[i], waitDuration[i])
label = c(trialTitle, rewardTitle)
View(plotData)
vaWaits[,cIdx],
vaWaits[,cIdx]
vaWaits = tempt$vaWaits
vaWaits[,1]
vaWaits[,2]
vaWaits[,3]
tempt = QStarModel(para, MSPara, otherPara, cond)
vaWaits = tempt$vaWaits
vaWaits[,2]
vaWaits[,1]
rm(list = ls(0))
rm(list = ls())
# this script analyzes the simulation data on the case level
###### load data and functions #######
source('subFxs/helperFxs.R')
library('ggplot2')
source('subFxs/plotThemes.R')
source('subFxs/wtwSettings.R')
load('outputs/QStarData/colpData.RData')
load('outputs/QStarData/RawHPData.RData')
load('outputs/QStarData/RawLPData.RData')
rm(list = ls())
# this script plot the dynamics of action values for a given para comb
# load functions and data
load('outputs/QStarData/initialSpace.RData')
source('subFxs/helperFxs.R')
source('subFxs/paraFxs.R')
source('subFxs/wtwSettings.R')
source('subFxs/plotThemes.R')
source('model.R')
library('ggplot2')
library('dplyr')
library('tidyr')
################ selec condition ################
# cond input
condIdx = 2
cond = conditions[condIdx];
condName = conditionNames[condIdx]
condColor = conditionColors[condIdx]
sprintf('Condition : %s %s', cond, condName)
# choose hdrData depending on Cond
load('outputs/QStarData/hdrData.RData')
if(condName == 'LP') hdrData = hdrLPData else hdrData = hdrHPData
stepDuration = hdrData$stepDuration
traceValues = hdrData$traceValues
sigma = hdrData$sigma
tMax = hdrData$tMax
########### choose the para and simulate data #############
combIdx = 100
para = initialSpace[combIdx,]
MSPara = getMSPara(cond, stepDuration, nMS, traceValues, sigma)
otherPara = getOtherPara(cond, stepDuration)
#
phi = para[1]
tau = para[2]
gamma = para[3]
lambda = para[4]
wIni = para[5]
# task para
source('subFxs/taskFxs.R')
source("subFxs/wtwSettings.R")
load('outputs/QStarData/xsLists.RData')
xsList = xsLists[[cond]]
# read otherPara
tMax= otherPara[['tMax']]
stepDuration = otherPara[['stepDuration']]
timeTicks = otherPara[['timeTicks']] # begin timepoint of states
nTimeStep = tMax / stepDuration
# read MSPara
nMS = MSPara$nMS
sigma = MSPara[['sigma']]
MSMus = MSPara[['MSMus']]
traceDecay = MSPara[['traceDecay']]
# define trace values of step t as 0.95^(t - 1)
# we can also define it as 0.95^t, it is abitrary
traceValues = traceDecay ^ ((1 : nTimeStep) - 1)
# actionList
actionList = c('wait', 'quit') # wait means wait until t+1, quit means quit at t
########### simulation repeatedly ############
# initialize action value, eligibility trace and stat
ws = rep(wIni, nMS) # weight vector for "wait"
#ws = rep(0, nMS) # weight vector for "wait"
#ws[1] = wIni # encourage explore at first
es = rep(0, nMS); # es vector for "wait"
onsetXs = xsList[1,]
xs = onsetXs
# additionally initialize vaWaits and vaQuits
vaWaits = matrix(NA, tMax / stepDuration, blockSecs / iti + 1);
vaQuits = matrix(NA, tMax / stepDuration, blockSecs / iti + 1);
endTimes = rep(NA, length = (blockSecs / iti + 1))
# initialize time and reward seq
totalSecs = 0
seq = c()
rewardDelays = rep(0, blockSecs / iti + 1)
tIdx = 0
stepGap = 1 # since es = 0 initially, so this value is abitratry
# initialize outputs
trialEarnings = rep(0, blockSecs / iti + 1)
timeWaited = rep(0, blockSecs / iti + 1)
# loop until time runs out
while(totalSecs < blockSecs) {
tIdx = tIdx + 1
# sample rewardDelay
rewardOutputs = drawSample(cond, seq)
rewardDelay = rewardOutputs[['delay']]
seq = rewardOutputs[['seq']]
# calculaye available time steps
# since we use floor there maybe 0.5 sec error (less than 90 s)
nAvaStep = min(floor((blockSecs - totalSecs) / stepDuration), nTimeStep)
# if near the block end, the check total Secs everytime
for(t in 1 : nAvaStep){
# calculte action value
vaQuit = onsetXs %*% ws * gamma^(iti / stepDuration) # didn't consider iTi, to stop getting things to complex
vaWait = xs %*% ws;
vaQuits[t, tIdx] = vaQuit;
vaWaits[t, tIdx] = vaWait;
# determine action
waitRate = exp(vaWait * tau) / sum(exp(vaWait* tau)  + exp(vaQuit * tau) )
# used to be exp(vaWait) * tau
# when gamma is large, sometimes vaWait will be very large, sothat waitRate is NA
if(is.na(waitRate)){
waitRate = 1
}
action = ifelse(runif(1) < waitRate, 'wait', 'quit')
# next reward
# determine whether reward occurs in the step t
# the previous code is wrong, since rewards happens on 16s seconds woudldn't be counted
rewardOccur = rewardDelay <= timeTicks[t + 1] && rewardDelay > timeTicks[t]
# if rewarded and wait, 5; otherwise, 0
getReward = (action == 'wait' && rewardOccur);
nextReward = ifelse(getReward, 5, 0)
# dertime next state
# go to the terminate state if at the final step or quit or reward arrives
trialGoOn= (action == 'wait' && !rewardOccur && t < nAvaStep)
if(trialGoOn){
nextXs = xsList[t+1,]
}else{
nextXs  = onsetXs
}
# update eligilibity trace
# here stepGap meatured between At and At-1
if(action == 'wait'){
es =  gamma^stepGap * lambda * es + xs * c(action == "wait")
# update stepGap
stepGap = ifelse(trialGoOn, 1, iti / stepDuration)
# update action value of quit and wait
# here stepGap meatured between At and At+1
delta = nextReward + c(gamma^(stepGap) * max(nextXs %*% ws, vaQuit) -
ifelse(action == 'wait', vaWait, vaQuit))
ws = ws + phi * delta * es
}
# update xs and stepGap
xs = nextXs
# break the trial didn't continue
# return output
if(!trialGoOn){
trialEarnings[tIdx] = ifelse(nextReward == 5, 5, 0);
# if quit, quit at t, if wait, wait until t+1
timeWaited[tIdx] = ifelse(getReward,NA, ifelse(action == "quit", timeTicks[t], timeTicks[t+1]))
rewardDelays[tIdx] = rewardDelay
break
}
}  # one trial end
#
if(t < nTimeStep){
vaWaits[(t+1) : nTimeStep] = xsList[(t+1) : nTimeStep,] %*% ws
}
# update totalSecs
totalSecs = totalSecs + iti+ ifelse(getReward, rewardDelay, timeWaited[tIdx])
endTimes[tIdx] = totalSecs
} # simulation end
vaWaits[,2]
t
(t < nTimeStep)
vaWaits[(t+1) : nTimeStep]
# this script plot the dynamics of action values for a given para comb
# load functions and data
load('outputs/QStarData/initialSpace.RData')
source('subFxs/helperFxs.R')
source('subFxs/paraFxs.R')
source('subFxs/wtwSettings.R')
source('subFxs/plotThemes.R')
source('model.R')
library('ggplot2')
library('dplyr')
library('tidyr')
# cond input
condIdx = 2
cond = conditions[condIdx];
condName = conditionNames[condIdx]
condColor = conditionColors[condIdx]
sprintf('Condition : %s %s', cond, condName)
# choose hdrData depending on Cond
load('outputs/QStarData/hdrData.RData')
if(condName == 'LP') hdrData = hdrLPData else hdrData = hdrHPData
stepDuration = hdrData$stepDuration
traceValues = hdrData$traceValues
sigma = hdrData$sigma
tMax = hdrData$tMax
########### choose the para and simulate data #############
combIdx = 100
para = initialSpace[combIdx,]
MSPara = getMSPara(cond, stepDuration, nMS, traceValues, sigma)
otherPara = getOtherPara(cond, stepDuration)
tempt = QStarModel(para, MSPara, otherPara, cond)
#######  calculate totalEarnings and conduct kmsc #######
totalEarnings = sum(tempt$trialEarnings)
waitDuration = tempt$timeWaited
rewardDelay = tempt$rewardDelays
quitIdx = (tempt$trialEarnings == 0)
waitDuration[is.na(waitDuration)] = rewardDelay[is.na(waitDuration)]
endTick = match(0,rewardDelay)
waitDuration = waitDuration[1 : (endTick - 1)]
quitIdx = quitIdx[1 : (endTick - 1)]
kmscResults =  kmscSimple(waitDuration, quitIdx, tMax, trialTick)
AUC = kmscResults$auc
label = sprintf('earn: %d, AUC: %.2f',
totalEarnings, AUC)
tempt = QStarModel(para, MSPara, otherPara, cond)
totalEarnings = sum(tempt$trialEarnings)
waitDuration = tempt$timeWaited
rewardDelay = tempt$rewardDelays
quitIdx = (tempt$trialEarnings == 0)
waitDuration[is.na(waitDuration)] = rewardDelay[is.na(waitDuration)]
endTick = match(0,rewardDelay)
waitDuration = waitDuration[1 : (endTick - 1)]
quitIdx = quitIdx[1 : (endTick - 1)]
kmscResults =  kmscSimple(waitDuration, quitIdx, tMax, trialTick)
AUC = kmscResults$auc
label = sprintf('earn: %d, AUC: %.2f',
totalEarnings, AUC)
trialTick = trialTicks[condIdx]
tempt = QStarModel(para, MSPara, otherPara, cond)
totalEarnings = sum(tempt$trialEarnings)
waitDuration = tempt$timeWaited
rewardDelay = tempt$rewardDelays
quitIdx = (tempt$trialEarnings == 0)
waitDuration[is.na(waitDuration)] = rewardDelay[is.na(waitDuration)]
endTick = match(0,rewardDelay)
waitDuration = waitDuration[1 : (endTick - 1)]
quitIdx = quitIdx[1 : (endTick - 1)]
kmscResults =  kmscSimple(waitDuration, quitIdx, tMax, trialTick)
AUC = kmscResults$auc
label = sprintf('earn: %d, AUC: %.2f',
totalEarnings, AUC)
######### plot trialData ##########
blockData = data.frame(trialEarnings = tempt$trialEarnings,
scheduledWait = tempt$rewardDelays,
timeWaited = tempt$timeWaited,
trialNum = 1 : length(tempt$timeWaited)
)
endTick = match(0, tempt$rewardDelays) - 1
blockData = blockData[1:endTick, ]
trialPlots(blockData, label)
label = sprintf('earn: %d, AUC: %.2f',
totalEarnings, AUC)
kmscResults =  kmscSimple(waitDuration, quitIdx, tMax, trialTick)
AUC = kmscResults$auc
trialTick = trialTicks[[condIdx]]
totalEarnings = sum(tempt$trialEarnings)
waitDuration = tempt$timeWaited
rewardDelay = tempt$rewardDelays
quitIdx = (tempt$trialEarnings == 0)
waitDuration[is.na(waitDuration)] = rewardDelay[is.na(waitDuration)]
endTick = match(0,rewardDelay)
waitDuration = waitDuration[1 : (endTick - 1)]
quitIdx = quitIdx[1 : (endTick - 1)]
kmscResults =  kmscSimple(waitDuration, quitIdx, tMax, trialTick)
AUC = kmscResults$auc
label = sprintf('earn: %d, AUC: %.2f',
totalEarnings, AUC)
######### plot trialData ##########
blockData = data.frame(trialEarnings = tempt$trialEarnings,
scheduledWait = tempt$rewardDelays,
timeWaited = tempt$timeWaited,
trialNum = 1 : length(tempt$timeWaited)
)
endTick = match(0, tempt$rewardDelays) - 1
blockData = blockData[1:endTick, ]
trialPlots(blockData, label)
# prepare data
vaWaits = tempt$vaWaits
vaQuits = tempt$vaQuits
wIni = para[5]
gamma = para[3]
nTimeStep = otherPara$tMax / otherPara$stepDuration
# unupdated vaWaits were not recorded, so here we manually
# set them identical with the last updated value
for(i in 1 : endTick){
vaQuits[is.na(vaQuits[,i]),i] = vaQuits[match(NA, vaQuits[,i]) -1,i]
}
# plot for each time step
for(i in 1: endTick){
cIdx = i
plotData = data.frame(va =c(vaWaits[,cIdx], vaQuits[,cIdx]),
time = rep( 1 : (otherPara$tMax / otherPara$stepDuration), 2),
action = rep(c('wait', 'quit'),
each = otherPara$tMax / otherPara$stepDuration))
trialTitle =  sprintf('Trial %d, ', i)
rewardTitle = sprintf('preR = %d, preT = %.2f; nowR = %d, nowT =%.2f',
tempt$trialEarnings[i-1], waitDuration[i-1],
tempt$trialEarnings[i], waitDuration[i])
label = c(trialTitle, rewardTitle)
if(is.na(tempt$timeWaited[i] )){
int_num = floor(tempt$rewardDelays[i])
endStep =  tempt$rewardDelays[i] + 0.5  + 0.5 * ((tempt$rewardDelays[i] - int_num) > 0.5)
endStep = endStep / stepDuration
}else{
endStep = tempt$timeWaited[i] / stepDuration
}
p = ggplot(plotData, aes(time, va, color = action)) + geom_line() +
geom_vline(xintercept = endStep) +
ggtitle(label) + xlab('time step') + ylab('action value') + displayTheme
print(p)
readline(prompt = paste(i, '(hit ENTER to continue)'))
}
close
